name: Deploy to VPS (symfony-docker)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: ~

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare VPS directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            mkdir -p ~/apps/neoodriver-backend
            sudo chown -R $USER:$USER ~/apps/neoodriver-backend || true
            sudo chattr -R -i ~/apps/neoodriver-backend 2>/dev/null || true
            chmod -R 755 ~/apps/neoodriver-backend

      - name: Upload project to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "./"
          target: "~/apps/neoodriver-backend"
          overwrite: true
          rm: true

      - name: Write production .env on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            ENV_PATH=~/apps/neoodriver-backend/.env
            {
              echo "APP_ENV=prod"
              echo "APP_DEBUG=0"
              echo "APP_SECRET=${{ secrets.APP_SECRET }}"
              echo "SERVER_NAME=${{ secrets.SERVER_NAME }}"
              echo "CADDY_MERCURE_JWT_SECRET=${{ secrets.CADDY_MERCURE_JWT_SECRET }}"
              echo ""
              echo "# MySQL"
              echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}"
              echo "MYSQL_USER=${{ secrets.MYSQL_USER }}"
              echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}"
              echo "MYSQL_VERSION=8.0"
              echo "MYSQL_CHARSET=utf8mb4"
            } > "$ENV_PATH"

      - name: Build and run services on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            docker compose -f compose.yaml -f compose.prod.yaml down --remove-orphans
            docker compose -f compose.yaml -f compose.prod.yaml pull --ignore-pull-failures
            docker compose -f compose.yaml -f compose.prod.yaml up -d --build --remove-orphans
