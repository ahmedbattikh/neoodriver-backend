name: Deploy to VPS (symfony-docker)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: ~

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare VPS directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            mkdir -p ~/apps/neoodriver-backend
            sudo chown -R $USER:$USER ~/apps/neoodriver-backend || true
            sudo chattr -R -i ~/apps/neoodriver-backend 2>/dev/null || true
            chmod -R 755 ~/apps/neoodriver-backend

      - name: Upload project to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "./"
          target: "~/apps/neoodriver-backend"
          overwrite: true
          rm: true

      - name: Write production .env on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            ENV_PATH=~/apps/neoodriver-backend/.env
            ENV_PROD_PATH=~/apps/neoodriver-backend/.env.prod
            {
              echo "APP_ENV=prod"
              echo "APP_DEBUG=0"
              echo "APP_SECRET=${{ secrets.APP_SECRET }}"
              echo "SERVER_NAME=${{ secrets.SERVER_NAME }}"
              echo "DEFAULT_URI=https://${{ secrets.SERVER_NAME }}"
              TP="${{ secrets.TRUSTED_PROXIES }}"
              if [ -z "$TP" ]; then
                TP="127.0.0.1,172.18.0.0/16"
                echo "[WARN] TRUSTED_PROXIES is empty; using default 127.0.0.1,172.18.0.0/16." >&2
              fi
              echo "TRUSTED_PROXIES=$TP"
              echo "COMPOSE_PROJECT_NAME=neoodriver-backend"
              # Prevent redirect loops: container serves plain HTTP; Nginx handles TLS
              echo "CADDY_GLOBAL_OPTIONS=\"auto_https off\""
              echo "DEPLOY_TAG=${{ github.ref_name }}"
              echo ""
              echo "# MySQL"
              echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}"
              echo "MYSQL_USER=${{ secrets.MYSQL_USER }}"
              echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}"
              echo "MYSQL_VERSION=8.0"
              echo "MYSQL_CHARSET=utf8mb4"
              MYSQL_ROOT_PASS="${{ secrets.MYSQL_ROOT_PASSWORD }}"
              if [ -z "$MYSQL_ROOT_PASS" ]; then
                MYSQL_ROOT_PASS="!ChangeMeRoot!"
                echo "[WARN] MYSQL_ROOT_PASSWORD is empty; using default placeholder. Set the GitHub secret for production." >&2
              fi
              echo "MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASS"
              echo "DATABASE_URL=mysql://${{ secrets.MYSQL_USER }}:${{ secrets.MYSQL_PASSWORD }}@mysql:3306/${{ secrets.MYSQL_DATABASE }}?serverVersion=8.0&charset=utf8mb4"
              echo ""
              echo "# phpMyAdmin"
              echo "PMA_USER=neooadmin"
              echo "PMA_PASSWORD=NeooDriver@9090"
              echo ""
              echo "# Mailer"
              MAILER_DSN_VAL="${{ secrets.MAILER_DSN }}"
              if [ -z "$MAILER_DSN_VAL" ]; then
                MAILER_DSN_VAL="null://null"
                echo "[WARN] MAILER_DSN is empty; using null://null for now." >&2
              fi
              echo "MAILER_DSN=$MAILER_DSN_VAL"
              echo ""
              echo "# JWT"
              JWT_PASSPHRASE_VAL="${{ secrets.JWT_PASSPHRASE }}"
              if [ -z "$JWT_PASSPHRASE_VAL" ]; then
                JWT_PASSPHRASE_VAL="ChangeMeStrongPassphrase"
                echo "[WARN] JWT_PASSPHRASE is empty; using placeholder. Set the GitHub secret for production." >&2
              fi
              echo "JWT_PASSPHRASE=$JWT_PASSPHRASE_VAL"
              JWT_TTL_VAL="${{ secrets.JWT_TTL }}"
              if [ -z "$JWT_TTL_VAL" ]; then
                JWT_TTL_VAL="3600"
                echo "[WARN] JWT_TTL is empty; defaulting to 3600." >&2
              fi
              echo "JWT_TTL=$JWT_TTL_VAL"
              JWT_REFRESH_TTL_VAL="${{ secrets.JWT_REFRESH_TTL }}"
              if [ -z "$JWT_REFRESH_TTL_VAL" ]; then
                JWT_REFRESH_TTL_VAL="2592000"
                echo "[WARN] JWT_REFRESH_TTL is empty; defaulting to 30 days (2592000)." >&2
              fi
              echo "JWT_REFRESH_TTL=$JWT_REFRESH_TTL_VAL"
              echo ""
              echo "# Cloudflare R2"
              echo "R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}"
              echo "R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}"
              echo "R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}"
              echo "R2_BUCKET=${{ secrets.R2_BUCKET }}"
              echo "R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}"
            } > "$ENV_PATH"
            cp "$ENV_PATH" "$ENV_PROD_PATH"

      - name: Build and run services on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml down --remove-orphans
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml pull --ignore-pull-failures
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml up -d --build --remove-orphans --wait

      - name: Ensure JWT key directory and generate keys on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            # Ensure host directory exists (bind-mounted in compose.prod.yaml)
            mkdir -p config/jwt
            # Generate keys only if missing
            if [ ! -f config/jwt/private.pem ] || [ ! -f config/jwt/public.pem ]; then
              echo "[INFO] Generating JWT keypair inside php container..."
              docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml exec -T php bin/console lexik:jwt:generate-keypair --no-interaction
            else
              echo "[INFO] JWT keys already exist; skipping generation."
            fi

      - name: Run Doctrine migrations and clear cache on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml exec -T php bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration --no-all-or-nothing
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml exec -T php bin/console cache:clear --no-interaction

      - name: Create MySQL user for phpMyAdmin on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            MYSQL_ROOT_PASS=$(grep -E '^MYSQL_ROOT_PASSWORD=' .env | sed -E 's/^MYSQL_ROOT_PASSWORD=//')
            # Create admin user if missing and grant privileges
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml exec -T mysql mysql -uroot -p"$MYSQL_ROOT_PASS" -e "CREATE USER IF NOT EXISTS 'neooadmin'@'%' IDENTIFIED BY 'NeooDriver@9090'; GRANT ALL PRIVILEGES ON *.* TO 'neooadmin'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
