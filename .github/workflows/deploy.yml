name: Deploy to VPS (symfony-docker)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: ~

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare VPS directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            mkdir -p ~/apps/neoodriver-backend
            sudo chown -R $USER:$USER ~/apps/neoodriver-backend || true
            sudo chattr -R -i ~/apps/neoodriver-backend 2>/dev/null || true
            chmod -R 755 ~/apps/neoodriver-backend

      - name: Upload project to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "./"
          target: "~/apps/neoodriver-backend"
          overwrite: true
          rm: true

      - name: Write production .env on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            cat > ~/apps/neoodriver-backend/.env <<'EOF'
APP_ENV=prod
APP_DEBUG=0
APP_SECRET=${{ secrets.APP_SECRET }}
SERVER_NAME=${{ secrets.SERVER_NAME }}
CADDY_MERCURE_JWT_SECRET=${{ secrets.CADDY_MERCURE_JWT_SECRET }}

# MySQL
MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
MYSQL_USER=${{ secrets.MYSQL_USER }}
MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
MYSQL_VERSION=8.0
MYSQL_CHARSET=utf8mb4
EOF

      - name: Build and run services on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            docker compose -f compose.yaml -f compose.prod.yaml down
            docker compose -f compose.yaml -f compose.prod.yaml up -d --build --pull --remove-orphans
