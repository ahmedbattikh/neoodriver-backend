name: Deploy to VPS (symfony-docker)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: ~

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare VPS directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            mkdir -p ~/apps/neoodriver-backend
            sudo chown -R $USER:$USER ~/apps/neoodriver-backend || true
            sudo chattr -R -i ~/apps/neoodriver-backend 2>/dev/null || true
            chmod -R 755 ~/apps/neoodriver-backend

      - name: Upload project to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          source: "./"
          target: "~/apps/neoodriver-backend"
          overwrite: true
          rm: true

      - name: Write production .env on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -eu
            ENV_PATH=~/apps/neoodriver-backend/.env
            {
              echo "APP_ENV=prod"
              echo "APP_DEBUG=0"
              echo "APP_SECRET=${{ secrets.APP_SECRET }}"
              echo "SERVER_NAME=${{ secrets.SERVER_NAME }}"
              echo "DEFAULT_URI=https://${{ secrets.SERVER_NAME }}"
              echo "COMPOSE_PROJECT_NAME=neoodriver-backend"
              # Prevent redirect loops: container serves plain HTTP; Nginx handles TLS
              echo "CADDY_GLOBAL_OPTIONS=\"auto_https off\""
              echo "DEPLOY_TAG=${{ github.ref_name }}"
              echo ""
              echo "# MySQL"
              echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}"
              echo "MYSQL_USER=${{ secrets.MYSQL_USER }}"
              echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}"
              echo "MYSQL_VERSION=8.0"
              echo "MYSQL_CHARSET=utf8mb4"
              MYSQL_ROOT_PASS="${{ secrets.MYSQL_ROOT_PASSWORD }}"
              if [ -z "$MYSQL_ROOT_PASS" ]; then
                MYSQL_ROOT_PASS="!ChangeMeRoot!"
                echo "[WARN] MYSQL_ROOT_PASSWORD is empty; using default placeholder. Set the GitHub secret for production." >&2
              fi
              echo "MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASS"
              echo "DATABASE_URL=mysql://${{ secrets.MYSQL_USER }}:${{ secrets.MYSQL_PASSWORD }}@mysql:3306/${{ secrets.MYSQL_DATABASE }}?serverVersion=8.0&charset=utf8mb4"
              echo ""
              echo "# phpMyAdmin"
              echo "PMA_USER=neooadmin"
              echo "PMA_PASSWORD=NeooDriver@9090"
            } > "$ENV_PATH"

      - name: Build and run services on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml down --remove-orphans
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml pull --ignore-pull-failures
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml up -d --build --remove-orphans

      - name: Create MySQL user for phpMyAdmin on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -eu
            cd ~/apps/neoodriver-backend
            MYSQL_ROOT_PASS=$(grep -E '^MYSQL_ROOT_PASSWORD=' .env | sed -E 's/^MYSQL_ROOT_PASSWORD=//')
            # Create admin user if missing and grant privileges
            docker compose -p neoodriver-backend -f compose.yaml -f compose.prod.yaml exec -T mysql mysql -uroot -p"$MYSQL_ROOT_PASS" -e "CREATE USER IF NOT EXISTS 'neooadmin'@'%' IDENTIFIED BY 'NeooDriver@9090'; GRANT ALL PRIVILEGES ON *.* TO 'neooadmin'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
