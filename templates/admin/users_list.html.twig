{% extends '@EasyAdmin/layout.html.twig' %}

{% block content_title %}Users
{% endblock %}

{% block head_styles %}
	<style>
		.users-grid {
			display: grid;
			grid-template-columns: repeat(3, 400px);
			justify-content: start;
			justify-items: start;
			align-items: start;
			grid-auto-flow: row;
			width: 100%;
			gap: 1rem;
		}
		.user-card .card {
			max-width: 400px;
		}
		.user-card {
			display: block;
		}
		.user-card .card-body {
			align-items: center;
		}
		.user-card img.rounded-circle.me-3 {
			width: 100px;
			height: 100px;
			object-fit: cover;
		}
		.user-card .placeholder {
			width: 100px;
			height: 100px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
	</style>
{% endblock %}

{% block content %}
	<div class="container py-3">
		<div class="mb-3 d-flex align-items-center gap-2">
			<input id="user-search" type="text" class="form-control" placeholder="Search users by name, email or phone"/>
			<div class="btn-group ms-2" role="group">
				<button type="button" class="btn btn-outline-secondary filter-btn active" data-filter="all">All</button>
				<button type="button" class="btn btn-outline-secondary filter-btn" data-filter="verified">Verified</button>
				<button type="button" class="btn btn-outline-secondary filter-btn" data-filter="unverified">Unverified</button>
			</div>
		</div>
		<div class="users-grid" id="users-grid">
			{% for u in users %}
				{% set driver = u.driverProfile %}
				{% set step = 1 %}
				{% if driver %}
					{% set step = 2 %}
					{% if driver.documents %}
						{% set step = 3 %}
						{% if driver.companyDocuments %}
							{% set step = 4 %}
							{% if driver.vehicles|length > 0 %}
								{% set step = 5 %}
							{% endif %}
						{% endif %}
					{% endif %}
				{% endif %}
				{% set status = driver and driver.active ? 'Active' : 'Disabled' %}
				{% set searchText = (u.email ~ ' ' ~ (u.firstName ?? '') ~ ' ' ~ (u.lastName ?? '') ~ ' ' ~ (u.mobileNumber ?? ''))|lower %}
				{% set verifiedFlag = u.verified ? 'verified' : 'unverified' %}
				<div class="user-card" data-search="{{ searchText }}" data-verified="{{ verifiedFlag }}">
					<div class="card h-100">
						<div class="card-body d-flex align-items-center">
							{% set avatar = avatars[u.id] ?? null %}
							{% if avatar %}
								<img src="{{ avatar }}" alt="avatar" class="rounded-circle me-3">
							{% else %}
								<div class="rounded-circle bg-secondary text-white fw-bold placeholder me-3">
									{{ (u.firstName ?? '')|slice(0,1)|upper }}
								</div>
							{% endif %}
							<div class="flex-grow-1">
								<div class="d-flex align-items-center justify-content-between">
									<div>
										<div class="fw-semibold">{{ (u.firstName ?? '') ~ ' ' ~ (u.lastName ?? '') }}</div>
										<div class="text-muted small">{{ u.email }}</div>
									</div>
									<span class="badge {{ u.verified ? 'bg-success' : 'bg-secondary' }}">{{ u.verified ? 'Verified' : 'Unverified' }}</span>
								</div>
								<div class="mt-2 d-flex align-items-center gap-2">
									<span class="badge {{ status == 'Active' ? 'bg-primary' : 'bg-warning' }}">{{ status }}</span>
									<span class="badge bg-info">Step
										{{ step }}</span>
								</div>
								<div class="mt-3 d-flex flex-wrap gap-1">
									{% if step < 5 %}
										<a class="btn btn-sm btn-primary" href="{{ path('admin_user_wizard_resume', { id: u.id, step: step }) }}">Resume</a>
									{% endif %}
									<a class="btn btn-sm btn-outline-secondary" href="{{ path('admin_user_show', { id: u.id }) }}">Show</a>
									<a class="btn btn-sm btn-outline-info" href="{{ path('admin_user_edit', { id: u.id }) }}">Edit</a>
									{% if status == 'Active' %}
										<a class="btn btn-sm btn-warning" href="{{ path('admin_user_toggle', { id: u.id, active: 0 }) }}">Disable</a>
									{% else %}
										<a class="btn btn-sm btn-success" href="{{ path('admin_user_toggle', { id: u.id, active: 1 }) }}">Enable</a>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
				</div>
			{% endfor %}
		</div>
	{% endblock %}

	{% block body_javascript %}
		<script>
			(function () {
const searchInput = document.getElementById('user-search');
const cards = Array.from(document.querySelectorAll('#users-grid .user-card'));
const filters = Array.from(document.querySelectorAll('.filter-btn'));
function apply() {
const q = (searchInput.value || '').toLowerCase();
const activeFilter = filters.find(b => b.classList.contains('active')) ?. dataset.filter || 'all';
cards.forEach(card => {
const text = card.dataset.search || '';
const vf = card.dataset.verified || 'unverified';
const matchText = q === '' || text.includes(q);
const matchFilter = activeFilter === 'all' || activeFilter === vf;
card.style.display = (matchText && matchFilter) ? '' : 'none';
});
}
searchInput.addEventListener('input', apply);
filters.forEach(b => {
b.addEventListener('click', () => {
filters.forEach(x => x.classList.remove('active'));
b.classList.add('active');
apply();
});
});
apply();
})();
		</script>
	{% endblock %}
