{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}{{ title }}{% endblock %}

{% block content %}
  <div class="container py-4">
    <div class="mb-4">
      <div class="progress" style="height: 8px;">
        {% set pct = (step / 5.0) * 100 %}
        <div class="progress-bar" role="progressbar" style="width: {{ pct }}%;" aria-valuenow="{{ pct|round }}" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="mt-2 text-muted">
        Step {{ step }} of 5
      </div>
    </div>

    {{ form_start(form) }}
      {{ form_widget(form) }}
      <div class="mt-3 d-flex gap-2">
        {% if step > 1 %}
          <a class="btn btn-outline-secondary" href="{{ path('admin_user_wizard', { step: step - 1 }) }}">Back</a>
        {% endif %}
        <button type="submit" class="btn btn-primary">Next</button>
      </div>
    {{ form_end(form) }}
  </div>
{% endblock %}

{% block body_javascript %}
  {{ parent() }}
  {% if step == 4 %}
    <script>
      (function(){
        const makeId = '{{ form.make.vars.id }}';
        const modelId = '{{ form.model.vars.id }}';
        const makeEl = document.getElementById(makeId);
        const modelEl = document.getElementById(modelId);
        if (!makeEl || !modelEl) return;
        function clearModels(){
          if (modelEl.tagName === 'SELECT') {
            while (modelEl.options.length) modelEl.remove(0);
            const opt = document.createElement('option');
            opt.value = ''; opt.textContent = 'Select model';
            modelEl.appendChild(opt);
          } else {
            modelEl.value = '';
          }
          if (modelEl.tomselect) {
            modelEl.tomselect.clearOptions();
            modelEl.tomselect.addOption({value: '', text: 'Select model'});
            modelEl.tomselect.refreshOptions(false);
          }
        }
        function populateMakes(makes){
          if (makeEl.tagName === 'SELECT') {
            while (makeEl.options.length) makeEl.remove(0);
            const opt = document.createElement('option'); opt.value=''; opt.textContent='Select make'; makeEl.appendChild(opt);
            makes.forEach(function(m){ const o=document.createElement('option'); o.value=m; o.textContent=m; makeEl.appendChild(o); });
          }
          if (makeEl.tomselect) {
            makeEl.tomselect.clearOptions();
            makeEl.tomselect.addOption({value: '', text: 'Select make'});
            makeEl.tomselect.addOptions(makes.map(function(m){ return {value:m, text:m}; }));
            makeEl.tomselect.refreshOptions(false);
          }
        }
        function populateModels(models){
          if (modelEl.tagName === 'SELECT') {
            clearModels();
            models.forEach(function(m){
              const opt = document.createElement('option');
              opt.value = m; opt.textContent = m; modelEl.appendChild(opt);
            });
          }
          if (modelEl.tomselect) {
            modelEl.tomselect.clearOptions();
            modelEl.tomselect.addOptions(models.map(function(m){ return {value:m, text:m}; }));
            modelEl.tomselect.refreshOptions(false);
          }
        }
        fetch('/data/all-vehicles-model.json')
          .then(function(r){ return r.ok ? r.json() : {}; })
          .then(function(data){
            var map = (typeof data === 'object' && data && !Array.isArray(data)) ? data : {};
            var makes = Object.keys(map).sort(function(a,b){ return a.localeCompare(b); });
            populateMakes(makes);
            function update(){
              var mk = makeEl.value || '';
              var models = (mk && map[mk]) ? map[mk].slice().sort(function(a,b){ return a.localeCompare(b); }) : [];
              populateModels(models);
            }
            makeEl.addEventListener('change', update);
            update();
          })
          .catch(function(){});
      })();
    </script>
  {% endif %}
{% endblock %}