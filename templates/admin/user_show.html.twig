{% extends '@EasyAdmin/layout.html.twig' %}

{% block head_favicon %}
	<link rel="icon" href="{{ asset('favicon.ico') }}">
{% endblock %}

{% block responsive_header_logo %}
	<a class="responsive-logo" title="Administration" href="{{ path('admin') }}">
		Administration
	</a>
{% endblock %}

{% block header_logo %}
	<a class="logo" title="Administration" href="{{ path('admin') }}">
		<span class="logo-custom">Administration</span>
		<span class="logo-compact">
			<i class="fas fa-home"></i>
		</span>
	</a>
{% endblock %}

{% macro preview(att, url) %}
	{% if url %}
		{% set mime = att.mimeType|lower %}
		{% if mime starts with 'image/' %}
			<div class="mt-2">
				<a href="{{ url }}" target="_blank">
					<img src="{{ url }}" alt="{{ att.originalFileName ?? att.fileName }}" style="width:200px;height:200px;object-fit:cover;border:1px solid #ddd;border-radius:4px;"/>
				</a>
			</div>
		{% elseif 'pdf' in mime %}
			<div class="mt-2">
				<a href="{{ url }}" target="_blank" class="btn btn-sm btn-outline-danger">PDF</a>
			</div>
		{% endif %}
	{% endif %}
{% endmacro %}

{% import _self as ui %}

{% block content_title %}User Details
{% endblock %}

{% block flash_messages %}
	{% for label, messages in app.flashes() %}
		{% for message in messages %}
			<div class="alert alert-{{ label }} mb-2">{{ message }}</div>
		{% endfor %}
	{% endfor %}
{% endblock %}

{% block content %}
	<div class="container py-4">
		{% for label, messages in app.flashes() %}
			{% for message in messages %}
				<div class="alert alert-{{ label }} mb-2">{{ message }}</div>
			{% endfor %}
		{% endfor %}
		{% set driver = user.driverProfile %}
		{% set status = driver and driver.active ? 'Active' : 'Disabled' %}

		{% if form is defined %}
			{{ form_start(form) }}
			{{ form_widget(form) }}
			<button type="submit" class="btn btn-primary">Save</button>
			<a href="{{ path('admin_users_list') }}" class="btn btn-outline-secondary">Back</a>
			{{ form_end(form) }}
		{% else %}
			<div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
				<div class="me-2">Verification:
					{{ user.verified ? 'Verified' : 'Unverified' }}</div>
				{% if user.verified %}
					<form method="post" action="{{ path('admin_user_verify', { id: user.id }) }}" class="d-inline">
						<input type="hidden" name="_token" value="{{ csrf_token('verify_user_' ~ user.id) }}"/>
						<input type="hidden" name="val" value="0"/>
						<button type="submit" class="btn btn-warning">Set Unverified</button>
					</form>
				{% else %}
					<form method="post" action="{{ path('admin_user_verify', { id: user.id }) }}" class="d-inline">
						<input type="hidden" name="_token" value="{{ csrf_token('verify_user_' ~ user.id) }}"/>
						<input type="hidden" name="val" value="1"/>
						<button type="submit" class="btn btn-success">Set Verified</button>
					</form>
				{% endif %}
				<form method="post" action="{{ path('admin_user_activate_notify', { id: user.id }) }}" class="d-inline">
					<input type="hidden" name="_token" value="{{ csrf_token('activate_notify_' ~ user.id) }}"/>
					<button type="submit" class="btn btn-primary">Activate + Notify</button>
				</form>
				<form method="post" action="{{ path('admin_user_notify_docs', { id: user.id }) }}" class="d-inline">
					<input type="hidden" name="_token" value="{{ csrf_token('notify_docs_' ~ user.id) }}"/>
					<button type="submit" class="btn btn-outline-primary">Notify Document Status</button>
				</form>
				<form method="post" action="{{ path('admin_user_companydocs_start', { id: user.id }) }}" class="d-inline">
					<input type="hidden" name="_token" value="{{ csrf_token('start_company_docs_' ~ user.id) }}"/>
					<button type="submit" class="btn btn-outline-success">Add Company Documents</button>
				</form>
			</div>
			{% if driver %}
				<div class="row g-3 mb-3">
					<div class="col-md-6 col-lg-3">
						<div class="card h-100">
							<div class="card-body">
								<div class="fw-bold">Profile Picture</div>
								{% if user.picProfile %}
									{{ ui.preview(user.picProfile, attachmentUrls[user.picProfile.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
						</div>
					</div>
					<div class="col-md-6 col-lg-4">
						<div class="card h-100">
							<div class="card-body">
								<div class="fw-bold mb-2">User Details</div>
								<div>
									<strong>User ID:</strong>
									{{ user.id }}</div>
								<div>
									<strong>Email:</strong>
									{{ user.email }}</div>
								<div>
									<strong>Full Name:</strong>
									{{ user.firstName }}
									{{ user.lastName }}</div>
								<div>
									<strong>Phone:</strong>
									{{ user.mobileNumber }}</div>
								<div>
									<strong>Verified:</strong>
									{{ user.verified ? 'Yes' : 'No' }}</div>
							</div>
						</div>
					</div>
					<div class="col-md-6 col-lg-5">
						<div class="card h-100">
							<div class="card-body">
								<div class="fw-bold mb-2">Driver Details</div>
								<div>
									<strong>Driver ID:</strong>
									{{ driver.id }}</div>
								<div>
									<strong>Class:</strong>
									{{ driver.classDriver }}</div>
								<div>
									<strong>Status:</strong>
									{{ status }}</div>
								<div>
									<strong>Created At:</strong>
									{{ driver.createdAt|date('Y-m-d H:i') }}</div>
								<div>
									<strong>Updated At:</strong>
									{{ driver.updatedAt|date('Y-m-d H:i') }}</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row g-3 mb-3">
					<div class="col-md-6 col-lg-3">
						<div class="card h-100">
							<div class="card-body">
								<div class="fw-bold">Total</div>
								<div class="display-6">{{ balanceSold|number_format(3, '.', ' ') }}</div>
							</div>
						</div>
					</div>
					<div class="col-md-6 col-lg-3">
						<div class="card h-100">
							<div class="card-body">
								<div class="fw-bold">Total Debits</div>
								<div class="display-6 text-danger">{{ balanceTotalDebit|number_format(3, '.', ' ') }}</div>
							</div>
						</div>
					</div>
					<div class="col-md-6 col-lg-3">
						<div class="card h-100">
							<div class="card-body">
								<div class="fw-bold">Sold Congé</div>
								<div class="display-6">{{ balanceSoldConge|number_format(3, '.', ' ') }}</div>
							</div>
						</div>
					</div>
					<div class="col-md-6 col-lg-3">
						<div class="card h-100">
							<div class="card-body">
								<div class="fw-bold">Last Update</div>
								<div class="display-6" style="font-size:1.25rem">{{ balanceLastUpdate ? balanceLastUpdate|date('Y-m-d H:i') : 'N/A' }}</div>
							</div>
						</div>
					</div>
				</div>
			{% endif %}
			<ul class="nav nav-tabs" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link {{ activeTab == 'info' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-info" type="button" role="tab">Info</button>
				</li>
				{% if driver %}
					<li class="nav-item" role="presentation">
						<button class="nav-link {{ activeTab == 'driver' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-driver" type="button" role="tab">Driver Documents</button>
					</li>
					{% if driver.companyDocuments %}
						<li class="nav-item" role="presentation">
							<button class="nav-link {{ activeTab == 'company' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-company" type="button" role="tab">Company Documents</button>
						</li>
					{% endif %}
					<li class="nav-item" role="presentation">
						<button class="nav-link {{ activeTab == 'vehicle' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-vehicle" type="button" role="tab">Vehicle</button>
					</li>
					<li class="nav-item" role="presentation">
						<button class="nav-link {{ activeTab == 'integrations' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-integrations" type="button" role="tab">Driver Integrations</button>
					</li>
					<li class="nav-item" role="presentation">
						<button class="nav-link {{ activeTab == 'expenses' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-expenses" type="button" role="tab">Expense Notes</button>
					</li>
				{% endif %}
				<li class="nav-item" role="presentation">
					<button class="nav-link {{ activeTab == 'ops' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-ops" type="button" role="tab">Operations</button>
				</li>
				{% if driver %}
					<li class="nav-item" role="presentation">
						<button class="nav-link {{ activeTab == 'advance' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-advance" type="button" role="tab">Advance Requests</button>
					</li>
				{% endif %}
				<li class="nav-item" role="presentation">
					<button class="nav-link {{ activeTab == 'batches' ? 'active' : '' }}" data-bs-toggle="tab" data-bs-target="#tab-batches" type="button" role="tab">Payment Batches</button>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link {{ activeTab == 'neoo' ? 'active' : '' }}" href="{{ path('admin_user_show', { id: user.id, tab: 'neoo' }) }}" role="tab">Neoo Details Paye</a>
				</li>
			</ul>

			<div class="tab-content pt-3">
				<div class="tab-pane fade {{ activeTab == 'info' ? 'show active' : '' }}" id="tab-info" role="tabpanel">
					<div class="mb-3">
						<div>
							<strong>ID:</strong>
							{{ user.id }}</div>
						<div>
							<strong>Email:</strong>
							{{ user.email }}</div>
						<div>
							<strong>First Name:</strong>
							{{ user.firstName }}</div>
						<div>
							<strong>Last Name:</strong>
							{{ user.lastName }}</div>
						<div>
							<strong>Phone:</strong>
							{{ user.mobileNumber }}</div>
						<div>
							<strong>Status:</strong>
							{{ status }}</div>
					</div>
					{% if driver %}
						<div class="row g-3">
							<div class="col-md-6 col-lg-4">
								<div class="card">
									<div class="card-body">
										<div class="fw-bold">Current Week Total</div>
										<div class="text-muted small">{{ weekStart|date('Y-m-d') }}
											→
											{{ weekEnd|date_modify('-1 day')|date('Y-m-d') }}</div>
										<div class="mt-2">In:
											{{ weekIn|number_format(3, '.', ' ') }}
											{{ weekCurrency ?? '' }}</div>
										<div>Out:
											{{ weekOut|number_format(3, '.', ' ') }}
											{{ weekCurrency ?? '' }}</div>
										<div class="mt-2">Net:
											<span class="{{ weekNet >= 0 ? 'text-success' : 'text-danger' }}">{{ weekNet|number_format(3, '.', ' ') }}
												{{ weekCurrency ?? '' }}</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					{% endif %}
					<div class="d-flex gap-2">
						<a class="btn btn-outline-info" href="{{ path('admin_user_edit', { id: user.id }) }}">Edit</a>
						{% if status == 'Active' %}
							<a class="btn btn-warning" href="{{ path('admin_user_toggle', { id: user.id, active: 0 }) }}">Disable</a>
						{% else %}
							<a class="btn btn-success" href="{{ path('admin_user_toggle', { id: user.id, active: 1 }) }}">Enable</a>
						{% endif %}
						<a class="btn btn-outline-secondary" href="{{ path('admin_users_list') }}">Back</a>
					</div>
				</div>

				{% if driver and driver.documents %}
					{% set docs = driver.documents %}
					<div class="tab-pane fade {{ activeTab == 'driver' ? 'show active' : '' }}" id="tab-driver" role="tabpanel">
						<div class="row g-3">
							<div class="col-md-6">
								<div class="fw-bold">Identity Photo</div>
								{% if docs.identityPhoto %}
									<div>
										{{ docs.identityPhoto.originalFileName ?? docs.identityPhoto.fileName }}
										{% if attachmentUrls[docs.identityPhoto.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.identityPhoto.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(docs.identityPhoto, attachmentUrls[docs.identityPhoto.id] ?? null) }}
									<div>{{ docs.identityPhoto.mimeType }}
										·
										{{ (docs.identityPhoto.fileSize / 1024)|round(1) }}
										KB</div>
									<div class="text-muted">{{ docs.identityPhoto.filePath }}</div>
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
							<div class="col-md-6">
								<div class="fw-bold">VTC Card</div>
								<div class="mb-1">Front:
									{% if docs.vtcCardFront %}
										{{ docs.vtcCardFront.originalFileName ?? docs.vtcCardFront.fileName }}
										{% if attachmentUrls[docs.vtcCardFront.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.vtcCardFront.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
										{{ ui.preview(docs.vtcCardFront, attachmentUrls[docs.vtcCardFront.id] ?? null) }}
										{% else %}Not uploaded
									{% endif %}
								</div>
								<div class="mb-1">Back:
									{% if docs.vtcCardBack %}
										{{ docs.vtcCardBack.originalFileName ?? docs.vtcCardBack.fileName }}
										{% if attachmentUrls[docs.vtcCardBack.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.vtcCardBack.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
										{{ ui.preview(docs.vtcCardBack, attachmentUrls[docs.vtcCardBack.id] ?? null) }}
										{% else %}Not uploaded
									{% endif %}
								</div>
								<div class="mb-1">Validity:
									<form method="post" action="{{ path('admin_user_doc_valid', { id: user.id }) }}" class="d-inline">
										<input type="hidden" name="_token" value="{{ csrf_token('update_validation_' ~ user.id ~ '_vtcCardValid') }}"/>
										<input type="hidden" name="field" value="vtcCardValid"/>
										<select name="value" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
											{% for opt in validationChoices %}
												<option value="{{ opt }}" {% if docs.vtcCardValid.value == opt %} selected {% endif %}>{{ opt }}</option>
											{% endfor %}
										</select>
									</form>
								</div>
								<div>Expiration:
									{{ docs.vtcCardExpirationDate ? docs.vtcCardExpirationDate|date('Y-m-d') : 'N/A' }}</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Driving License</div>
								<div class="mb-1">Front:
									{% if docs.drivingLicenseFront %}
										{{ docs.drivingLicenseFront.originalFileName ?? docs.drivingLicenseFront.fileName }}
										{% if attachmentUrls[docs.drivingLicenseFront.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.drivingLicenseFront.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
										{% else %}Not uploaded
									{% endif %}
								</div>
								{{ ui.preview(docs.drivingLicenseFront, attachmentUrls[docs.drivingLicenseFront.id] ?? null) }}
								<div class="mb-1">Back:
									{% if docs.drivingLicenseBack %}
										{{ docs.drivingLicenseBack.originalFileName ?? docs.drivingLicenseBack.fileName }}
										{% if attachmentUrls[docs.drivingLicenseBack.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.drivingLicenseBack.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
										{% else %}Not uploaded
									{% endif %}
								</div>
								{{ ui.preview(docs.drivingLicenseBack, attachmentUrls[docs.drivingLicenseBack.id] ?? null) }}
								<div class="mb-1">Validity:
									<form method="post" action="{{ path('admin_user_doc_valid', { id: user.id }) }}" class="d-inline">
										<input type="hidden" name="_token" value="{{ csrf_token('update_validation_' ~ user.id ~ '_drivingLicenseValid') }}"/>
										<input type="hidden" name="field" value="drivingLicenseValid"/>
										<select name="value" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
											{% for opt in validationChoices %}
												<option value="{{ opt }}" {% if docs.drivingLicenseValid.value == opt %} selected {% endif %}>{{ opt }}</option>
											{% endfor %}
										</select>
									</form>
								</div>
								<div>Expiration:
									{{ docs.drivingLicenseExpirationDate ? docs.drivingLicenseExpirationDate|date('Y-m-d') : 'N/A' }}</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Identity Card</div>
								<div class="mb-1">Front:
									{% if docs.identityCardFront %}
										{{ docs.identityCardFront.originalFileName ?? docs.identityCardFront.fileName }}
										{% if attachmentUrls[docs.identityCardFront.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.identityCardFront.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
										{% else %}Not uploaded
									{% endif %}
								</div>
								{{ ui.preview(docs.identityCardFront, attachmentUrls[docs.identityCardFront.id] ?? null) }}
								<div class="mb-1">Back:
									{% if docs.identityCardBack %}
										{{ docs.identityCardBack.originalFileName ?? docs.identityCardBack.fileName }}
										{% if attachmentUrls[docs.identityCardBack.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.identityCardBack.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
										{% else %}Not uploaded
									{% endif %}
								</div>
								{{ ui.preview(docs.identityCardBack, attachmentUrls[docs.identityCardBack.id] ?? null) }}
								<div class="mb-1">Validity:
									<form method="post" action="{{ path('admin_user_doc_valid', { id: user.id }) }}" class="d-inline">
										<input type="hidden" name="_token" value="{{ csrf_token('update_validation_' ~ user.id ~ '_identityCardValid') }}"/>
										<input type="hidden" name="field" value="identityCardValid"/>
										<select name="value" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
											{% for opt in validationChoices %}
												<option value="{{ opt }}" {% if docs.identityCardValid.value == opt %} selected {% endif %}>{{ opt }}</option>
											{% endfor %}
										</select>
									</form>
								</div>
								<div>Expiration:
									{{ docs.identityCardExpirationDate ? docs.identityCardExpirationDate|date('Y-m-d') : 'N/A' }}</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Health Card</div>
								{% if docs.healthCard %}
									<div>
										{{ docs.healthCard.originalFileName ?? docs.healthCard.fileName }}
										{% if attachmentUrls[docs.healthCard.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.healthCard.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(docs.healthCard, attachmentUrls[docs.healthCard.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
								<div>Validity:
									<form method="post" action="{{ path('admin_user_doc_valid', { id: user.id }) }}" class="d-inline">
										<input type="hidden" name="_token" value="{{ csrf_token('update_validation_' ~ user.id ~ '_healthCardValid') }}"/>
										<input type="hidden" name="field" value="healthCardValid"/>
										<select name="value" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
											{% for opt in validationChoices %}
												<option value="{{ opt }}" {% if docs.healthCardValid.value == opt %} selected {% endif %}>{{ opt }}</option>
											{% endfor %}
										</select>
									</form>
								</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Social Security</div>
								<div>Number:
									{{ docs.socialSecurityNumber ?? 'N/A' }}</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Bank Statement</div>
								{% if docs.bankStatement %}
									<div>
										{{ docs.bankStatement.originalFileName ?? docs.bankStatement.fileName }}
										{% if attachmentUrls[docs.bankStatement.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.bankStatement.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(docs.bankStatement, attachmentUrls[docs.bankStatement.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
								<div>Validity:
									<form method="post" action="{{ path('admin_user_doc_valid', { id: user.id }) }}" class="d-inline">
										<input type="hidden" name="_token" value="{{ csrf_token('update_validation_' ~ user.id ~ '_bankStatementValid') }}"/>
										<input type="hidden" name="field" value="bankStatementValid"/>
										<select name="value" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
											{% for opt in validationChoices %}
												<option value="{{ opt }}" {% if docs.bankStatementValid.value == opt %} selected {% endif %}>{{ opt }}</option>
											{% endfor %}
										</select>
									</form>
								</div>
								<div>IBAN:
									{{ docs.iban ?? 'N/A' }}</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Hosting</div>
								<div>{{ docs.isHosted ? 'Hosted' : 'Not hosted' }}</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Proof of Residence</div>
								{% if docs.proofOfResidence %}
									<div>
										{{ docs.proofOfResidence.originalFileName ?? docs.proofOfResidence.fileName }}
										{% if attachmentUrls[docs.proofOfResidence.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.proofOfResidence.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(docs.proofOfResidence, attachmentUrls[docs.proofOfResidence.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
								<div>Validity:
									<form method="post" action="{{ path('admin_user_doc_valid', { id: user.id }) }}" class="d-inline">
										<input type="hidden" name="_token" value="{{ csrf_token('update_validation_' ~ user.id ~ '_proofOfResidenceValid') }}"/>
										<input type="hidden" name="field" value="proofOfResidenceValid"/>
										<select name="value" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
											{% for opt in validationChoices %}
												<option value="{{ opt }}" {% if docs.proofOfResidenceValid.value == opt %} selected {% endif %}>{{ opt }}</option>
											{% endfor %}
										</select>
									</form>
								</div>
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Secure Driving Right Certificate</div>
								{% if docs.secureDrivingRightCertificate %}
									<div>
										{{ docs.secureDrivingRightCertificate.originalFileName ?? docs.secureDrivingRightCertificate.fileName }}
										{% if attachmentUrls[docs.secureDrivingRightCertificate.id] is defined %}
											—
											<a href="{{ attachmentUrls[docs.secureDrivingRightCertificate.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(docs.secureDrivingRightCertificate, attachmentUrls[docs.secureDrivingRightCertificate.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
								<div>Validity:
									<form method="post" action="{{ path('admin_user_doc_valid', { id: user.id }) }}" class="d-inline">
										<input type="hidden" name="_token" value="{{ csrf_token('update_validation_' ~ user.id ~ '_secureDrivingRightCertificateValid') }}"/>
										<input type="hidden" name="field" value="secureDrivingRightCertificateValid"/>
										<select name="value" class="form-select form-select-sm d-inline w-auto" onchange="this.form.submit()">
											{% for opt in validationChoices %}
												<option value="{{ opt }}" {% if docs.secureDrivingRightCertificateValid.value == opt %} selected {% endif %}>{{ opt }}</option>
											{% endfor %}
										</select>
									</form>
								</div>
							</div>
						</div>
						<div class="mt-3 text-muted">Updated:
							{{ docs.updatedAt|date('Y-m-d H:i') }}</div>
					</div>
				{% endif %}
				{% if driver %}
					<div class="tab-pane fade {{ activeTab == 'advance' ? 'show active' : '' }}" id="tab-advance" role="tabpanel">
						<div class="card">
							<div class="card-body">
								<div class="fw-bold mb-2">Advance Requests</div>
								{% if advanceRequests is defined and advanceRequests|length > 0 %}
									<div class="table-responsive">
										<table class="table table-sm table-striped align-middle">
											<thead>
												<tr>
													<th>ID</th>
													<th>Amount</th>
													<th>Status</th>
													<th>Description</th>
													<th>Created</th>
													<th>Approved</th>
													<th>Attachment</th>
													<th>Actions</th>
												</tr>
											</thead>
											<tbody>
												{% for r in advanceRequests %}
													<tr>
														<td>{{ r.id }}</td>
														<td>{{ r.amount|number_format(3, '.', ' ') }}</td>
														<td>{{ r.status.value }}</td>
														<td>{{ r.description ?? '' }}</td>
														<td>{{ r.createdAt|date('Y-m-d H:i') }}</td>
														<td>{{ r.approvedAt ? r.approvedAt|date('Y-m-d H:i') : '—' }}</td>
														<td>
															{% if r.attachment %}
																{% set aurl = attachmentUrls[r.attachment.id] ?? null %}
																{% if aurl %}
																	<a href="{{ aurl }}" target="_blank" class="link-primary">Open</a>
																{% else %}
																	<span class="text-muted">N/A</span>
																{% endif %}
															{% else %}
																<span class="text-muted">None</span>
															{% endif %}
														</td>
														<td>
															{% if r.status.value == 'PENDING' %}
																<div class="d-flex flex-wrap align-items-center gap-2">
																	<form method="post" action="{{ path('admin_advance_request_approve', { id: r.id }) }}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
																		<input type="hidden" name="_token" value="{{ csrf_token('approve_advance_' ~ r.id) }}"/>
																		<input type="file" name="proof" class="form-control form-control-sm" accept="image/*,application/pdf" required />
																		<button type="submit" class="btn btn-sm btn-success">Approve</button>
																	</form>
																	<form method="post" action="{{ path('admin_advance_request_reject', { id: r.id }) }}" class="d-flex align-items-center gap-2">
																		<input type="hidden" name="_token" value="{{ csrf_token('reject_advance_' ~ r.id) }}"/>
																		<input type="text" name="admin_note" class="form-control form-control-sm" placeholder="Reason..." />
																		<button type="submit" class="btn btn-sm btn-outline-danger">Refuse</button>
																	</form>
																</div>
															{% else %}
																<span class="text-muted">—</span>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-muted">No advance requests</div>
								{% endif %}
							</div>
						</div>
					</div>
				{% endif %}

				{% if driver and driver.companyDocuments %}
					{% set cdocs = driver.companyDocuments %}
					<div class="tab-pane fade {{ activeTab == 'company' ? 'show active' : '' }}" id="tab-company" role="tabpanel">
						<div class="row g-3">
							<div class="col-md-6">
								<div class="fw-bold">Employment Contract</div>
								{% if cdocs.employmentContract %}
									<div>
										{{ cdocs.employmentContract.originalFileName ?? cdocs.employmentContract.fileName }}
										{% if attachmentUrls[cdocs.employmentContract.id] is defined %}
											—
											<a href="{{ attachmentUrls[cdocs.employmentContract.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(cdocs.employmentContract, attachmentUrls[cdocs.employmentContract.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Employer Certificate</div>
								{% if cdocs.employerCertificate %}
									<div>
										{{ cdocs.employerCertificate.originalFileName ?? cdocs.employerCertificate.fileName }}
										{% if attachmentUrls[cdocs.employerCertificate.id] is defined %}
											—
											<a href="{{ attachmentUrls[cdocs.employerCertificate.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(cdocs.employerCertificate, attachmentUrls[cdocs.employerCertificate.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Pre-employment Declaration</div>
								{% if cdocs.preEmploymentDeclaration %}
									<div>
										{{ cdocs.preEmploymentDeclaration.originalFileName ?? cdocs.preEmploymentDeclaration.fileName }}
										{% if attachmentUrls[cdocs.preEmploymentDeclaration.id] is defined %}
											—
											<a href="{{ attachmentUrls[cdocs.preEmploymentDeclaration.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(cdocs.preEmploymentDeclaration, attachmentUrls[cdocs.preEmploymentDeclaration.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
							<div class="col-md-6">
								<div class="fw-bold">Mutual Insurance Certificate</div>
								{% if cdocs.mutualInsuranceCertificate %}
									<div>
										{{ cdocs.mutualInsuranceCertificate.originalFileName ?? cdocs.mutualInsuranceCertificate.fileName }}
										{% if attachmentUrls[cdocs.mutualInsuranceCertificate.id] is defined %}
											—
											<a href="{{ attachmentUrls[cdocs.mutualInsuranceCertificate.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(cdocs.mutualInsuranceCertificate, attachmentUrls[cdocs.mutualInsuranceCertificate.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
							<div class="col-md-6">
								<div class="fw-bold">URSSAF Compliance Certificate</div>
								{% if cdocs.urssafComplianceCertificate %}
									<div>
										{{ cdocs.urssafComplianceCertificate.originalFileName ?? cdocs.urssafComplianceCertificate.fileName }}
										{% if attachmentUrls[cdocs.urssafComplianceCertificate.id] is defined %}
											—
											<a href="{{ attachmentUrls[cdocs.urssafComplianceCertificate.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(cdocs.urssafComplianceCertificate, attachmentUrls[cdocs.urssafComplianceCertificate.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
							<div class="col-md-6">
								<div class="fw-bold">KBIS Extract</div>
								{% if cdocs.kbisExtract %}
									<div>
										{{ cdocs.kbisExtract.originalFileName ?? cdocs.kbisExtract.fileName }}
										{% if attachmentUrls[cdocs.kbisExtract.id] is defined %}
											—
											<a href="{{ attachmentUrls[cdocs.kbisExtract.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(cdocs.kbisExtract, attachmentUrls[cdocs.kbisExtract.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
							<div class="col-md-6">
								<div class="fw-bold">REVTC Registration Certificate</div>
								{% if cdocs.revtcRegistrationCertificate %}
									<div>
										{{ cdocs.revtcRegistrationCertificate.originalFileName ?? cdocs.revtcRegistrationCertificate.fileName }}
										{% if attachmentUrls[cdocs.revtcRegistrationCertificate.id] is defined %}
											—
											<a href="{{ attachmentUrls[cdocs.revtcRegistrationCertificate.id] }}" target="_blank" class="link-primary">Open</a>
										{% endif %}
									</div>
									{{ ui.preview(cdocs.revtcRegistrationCertificate, attachmentUrls[cdocs.revtcRegistrationCertificate.id] ?? null) }}
								{% else %}
									<div class="text-muted">Not uploaded</div>
								{% endif %}
							</div>
						</div>
						<div class="mt-3 text-muted">Updated:
							{{ cdocs.updatedAt|date('Y-m-d H:i') }}</div>
					</div>
				{% endif %}

				{% if driver %}
					<div class="tab-pane fade {{ activeTab == 'vehicle' ? 'show active' : '' }}" id="tab-vehicle" role="tabpanel">
						{% if driver.vehicles|length > 0 %}
							<div class="row g-3">
								{% for v in driver.vehicles %}
									<div class="col-12">
										<div class="card">
											<div class="card-body">
												<div class="row g-3">
													<div class="col-md-6">
														<div>
															<strong>Registration Number:</strong>
															{{ v.registrationNumber }}</div>
														<div>
															<strong>Make:</strong>
															{{ v.make }}</div>
														<div>
															<strong>Model:</strong>
															{{ v.model }}</div>
														<div>
															<strong>First Registration Year:</strong>
															{{ v.firstRegistrationYear }}</div>
														<div>
															<strong>Registration Date:</strong>
															{{ v.registrationDate ? v.registrationDate|date('Y-m-d') : 'N/A' }}</div>
														<div>
															<strong>Seat Count:</strong>
															{{ v.seatCount }}</div>
														<div>
															<strong>Energy Type:</strong>
															{{ v.energyTypeValue }}</div>
														<div>
															<strong>Insurance Expiration:</strong>
															{{ v.insuranceExpirationDate ? v.insuranceExpirationDate|date('Y-m-d') : 'N/A' }}</div>
													</div>
													<div class="col-md-6">
														<div class="fw-bold">Registration Certificate</div>
														{% if v.registrationCertificate %}
															<div>
																{{ v.registrationCertificate.originalFileName ?? v.registrationCertificate.fileName }}
																{% if attachmentUrls[v.registrationCertificate.id] is defined %}
																	—
																	<a href="{{ attachmentUrls[v.registrationCertificate.id] }}" target="_blank" class="link-primary">Open</a>
																{% endif %}
															</div>
															{{ ui.preview(v.registrationCertificate, attachmentUrls[v.registrationCertificate.id] ?? null) }}
															<div class="text-muted">{{ v.registrationCertificate.filePath }}</div>
														{% else %}
															<div class="text-muted">Not uploaded</div>
														{% endif %}
														<div class="fw-bold mt-3">Paid Transport Insurance Certificate</div>
														{% if v.paidTransportInsuranceCertificate %}
															<div>
																{{ v.paidTransportInsuranceCertificate.originalFileName ?? v.paidTransportInsuranceCertificate.fileName }}
																{% if attachmentUrls[v.paidTransportInsuranceCertificate.id] is defined %}
																	—
																	<a href="{{ attachmentUrls[v.paidTransportInsuranceCertificate.id] }}" target="_blank" class="link-primary">Open</a>
																{% endif %}
															</div>
															{{ ui.preview(v.paidTransportInsuranceCertificate, attachmentUrls[v.paidTransportInsuranceCertificate.id] ?? null) }}
															<div class="text-muted">{{ v.paidTransportInsuranceCertificate.filePath }}</div>
														{% else %}
															<div class="text-muted">Not uploaded</div>
														{% endif %}
														<div class="fw-bold mt-3">Technical Inspection</div>
														{% if v.technicalInspection %}
															<div>
																{{ v.technicalInspection.originalFileName ?? v.technicalInspection.fileName }}
																{% if attachmentUrls[v.technicalInspection.id] is defined %}
																	—
																	<a href="{{ attachmentUrls[v.technicalInspection.id] }}" target="_blank" class="link-primary">Open</a>
																{% endif %}
															</div>
															{{ ui.preview(v.technicalInspection, attachmentUrls[v.technicalInspection.id] ?? null) }}
															<div class="text-muted">{{ v.technicalInspection.filePath }}</div>
														{% else %}
															<div class="text-muted">Not uploaded</div>
														{% endif %}
														<div class="fw-bold mt-3">Vehicle Front Photo</div>
														{% if v.vehicleFrontPhoto %}
															<div>
																{{ v.vehicleFrontPhoto.originalFileName ?? v.vehicleFrontPhoto.fileName }}
																{% if attachmentUrls[v.vehicleFrontPhoto.id] is defined %}
																	—
																	<a href="{{ attachmentUrls[v.vehicleFrontPhoto.id] }}" target="_blank" class="link-primary">Open</a>
																{% endif %}
															</div>
															{{ ui.preview(v.vehicleFrontPhoto, attachmentUrls[v.vehicleFrontPhoto.id] ?? null) }}
															<div class="text-muted">{{ v.vehicleFrontPhoto.filePath }}</div>
														{% else %}
															<div class="text-muted">Not uploaded</div>
														{% endif %}
														<div class="fw-bold mt-3">Insurance Note</div>
														{% if v.insuranceNote %}
															<div>
																{{ v.insuranceNote.originalFileName ?? v.insuranceNote.fileName }}
																{% if attachmentUrls[v.insuranceNote.id] is defined %}
																	—
																	<a href="{{ attachmentUrls[v.insuranceNote.id] }}" target="_blank" class="link-primary">Open</a>
																{% endif %}
															</div>
															{{ ui.preview(v.insuranceNote, attachmentUrls[v.insuranceNote.id] ?? null) }}
															<div class="text-muted">{{ v.insuranceNote.filePath }}</div>
														{% else %}
															<div class="text-muted">Not uploaded</div>
														{% endif %}
													</div>
												</div>
												<div class="mt-3 text-muted">Updated:
													{{ v.updatedAt|date('Y-m-d H:i') }}</div>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>
						{% else %}
							<div class="text-muted">No vehicles</div>
						{% endif %}
					</div>
				{% endif %}
				{% if driver %}
					<div class="tab-pane fade {{ activeTab == 'ops' ? 'show active' : '' }}" id="tab-ops" role="tabpanel">
						{% if operations|length > 0 %}
							<div class="table-responsive">
								<table class="table table-sm table-striped align-middle">
									<thead>
										<tr>
											<th>Date</th>
											<th>Integration</th>
											<th>Type</th>
											<th>Direction</th>
											<th>Amount</th>
											<th>Distance</th>
											<th>Tips</th>
											<th>Bonus</th>
											<th>Status</th>
											<th>Reference</th>
											<th>Description</th>
											<th>Original</th>
										</tr>
									</thead>
									<tbody>
										{% for op in operations %}
											<tr>
												<td>{{ op.occurredAt|date('Y-m-d H:i') }}</td>
												<td>{{ op.integrationCode }}</td>
												<td>{{ op.operationType }}</td>
												<td>{{ op.direction }}</td>
												<td>{{ op.amount|number_format(3, '.', ' ') ~ ' ' ~ op.currency }}</td>
												<td>
													{% if op.rideDistance is not null %}
														{{ op.rideDistance|number_format(3, '.', ' ') }}
														km
													{% else %}
														<span class="text-muted">N/A</span>
													{% endif %}
												</td>
												<td>{{ op.tips|number_format(3, '.', ' ') }}</td>
												<td>{{ op.bonus|number_format(3, '.', ' ') }}</td>
												<td>{{ op.status }}</td>
												<td>{{ op.externalReference ?? '' }}</td>
												<td>{{ op.description ?? '' }}</td>
												<td>
													{% if op.originalObject %}
														<button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#opModal-{{ op.id }}">Show Original</button>
														<div class="modal fade" id="opModal-{{ op.id }}" tabindex="-1" aria-hidden="true">
															<div class="modal-dialog modal-lg modal-dialog-scrollable">
																<div class="modal-content">
																	<div class="modal-header">
																		<h5 class="modal-title">Original Payload ({{ op.integrationCode }})</h5>
																		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
																	</div>
																	<div class="modal-body">
																		<pre style="white-space:pre-wrap;word-break:break-word;">{{ op.originalObject|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
																	</div>
																</div>
															</div>
														</div>
													{% else %}
														<span class="text-muted">N/A</span>
													{% endif %}
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
							{% if opsTotalPages > 1 %}
								<div class="d-flex align-items-center justify-content-between mt-2">
									<div>Page
										{{ opsPage }}
										of
										{{ opsTotalPages }}</div>
									<div class="btn-group">
										<a class="btn btn-outline-secondary btn-sm {% if opsPage <= 1 %}disabled{% endif %}" href="{{ path('admin_user_show', { id: user.id, ops_page: opsPage - 1, ops_size: opsSize, batches_page: batchesPage, batches_size: batchesSize, tab: 'ops' }) }}">Previous</a>
										<a class="btn btn-outline-secondary btn-sm {% if opsPage >= opsTotalPages %}disabled{% endif %}" href="{{ path('admin_user_show', { id: user.id, ops_page: opsPage + 1, ops_size: opsSize, batches_page: batchesPage, batches_size: batchesSize, tab: 'ops' }) }}">Next</a>
									</div>
								</div>
							{% endif %}
						{% else %}
							<div class="text-muted">No operations</div>
						{% endif %}
					</div>

					<div class="tab-pane fade {{ activeTab == 'integrations' ? 'show active' : '' }}" id="tab-integrations" role="tabpanel">
						<div class="row g-3">
							<div class="col-12">
								<div class="card">
									<div class="card-body">
										<div class="fw-bold mb-2">Existing Integration Accounts</div>
										{% if integrationAccounts|length > 0 %}
											<div class="table-responsive">
												<table class="table table-sm table-striped align-middle">
													<thead>
														<tr>
															<th>Integration</th>
															<th>Code</th>
															<th>Driver ID</th>
															<th>Created At</th>
															<th>Actions</th>
														</tr>
													</thead>
													<tbody>
														{% for acc in integrationAccounts %}
															<tr>
																<td>{{ acc.integration.name }}</td>
																<td>{{ acc.integration.code }}</td>
																<td>{{ acc.idDriver }}</td>
																<td>{{ acc.createdAt|date('Y-m-d H:i') }}</td>
																<td>
																	<form method="post" action="{{ path('admin_user_integration_account_sync', { id: user.id, accId: acc.id }) }}" class="d-inline">
																		<input type="hidden" name="_token" value="{{ csrf_token('sync_integration_account_' ~ user.id ~ '_' ~ acc.id) }}"/>
																		<button type="submit" class="btn btn-sm btn-outline-primary">Sync</button>
																	</form>
																	<form method="post" action="{{ path('admin_user_integration_account_sync', { id: user.id, accId: acc.id }) }}" class="d-inline ms-1">
																		<input type="hidden" name="_token" value="{{ csrf_token('sync_integration_account_' ~ user.id ~ '_' ~ acc.id) }}"/>
																		<input type="hidden" name="debug" value="1"/>
																		<button type="submit" class="btn btn-sm btn-outline-danger">Sync (Debug)</button>
																	</form>
																</td>
															</tr>
														{% endfor %}
													</tbody>
												</table>
											</div>
										{% else %}
											<div class="text-muted">No integration accounts</div>
										{% endif %}
									</div>
								</div>
							</div>
							<div class="col-12">
								<div class="card">
									<div class="card-body">
										<div class="fw-bold mb-2">Add Integration Account</div>
										<form method="post" action="{{ path('admin_user_integration_account_add', { id: user.id }) }}" class="row g-2">
											<input type="hidden" name="_token" value="{{ csrf_token('add_integration_account_' ~ user.id) }}"/>
											<div class="col-md-4">
												<select name="integrationId" class="form-select" required>
													<option value="" disabled selected>Select integration</option>
													{% for intg in enabledIntegrations %}
														<option value="{{ intg.id }}">{{ intg.name }}
															({{ intg.code }})</option>
													{% endfor %}
												</select>
											</div>
											<div class="col-md-4">
												<input type="text" name="idDriver" class="form-control" placeholder="External Driver ID" required/>
											</div>
											<div class="col-md-4">
												<button type="submit" class="btn btn-primary w-100">Add</button>
											</div>
										</form>
										{% if enabledIntegrations|length == 0 %}
											<div class="mt-2 text-muted">No enabled integrations configured</div>
										{% endif %}
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="tab-pane fade {{ activeTab == 'expenses' ? 'show active' : '' }}" id="tab-expenses" role="tabpanel">
						<div class="d-flex align-items-center justify-content-between mb-2">
							<div class="btn-group" role="group" aria-label="Notes filter">
								<a class="btn btn-sm btn-outline-secondary {{ notesFilter == 'all' ? 'active' : '' }}" href="{{ path('admin_user_show', { id: user.id, tab: 'expenses', notes_filter: 'all', notes_week: 0, notes_page: 1, notes_size: notesSize }) }}">All</a>
								<a class="btn btn-sm btn-outline-secondary {{ notesFilter == 'week' ? 'active' : '' }}" href="{{ path('admin_user_show', { id: user.id, tab: 'expenses', notes_filter: 'week', notes_week: notesWeek, notes_page: 1, notes_size: notesSize }) }}">This Week</a>
							</div>
							{% if notesFilter == 'week' %}
								<div class="d-flex align-items-center gap-2">
									<span class="text-muted small">Week
										{{ notesWeekStart|date('Y-m-d') }}
										→
										{{ notesWeekEnd|date_modify('-1 day')|date('Y-m-d') }}</span>
									<div class="btn-group" role="group">
										<a class="btn btn-sm btn-outline-secondary" href="{{ path('admin_user_show', { id: user.id, tab: 'expenses', notes_filter: 'week', notes_week: notesWeek - 1, notes_page: notesPage, notes_size: notesSize }) }}">Prev</a>
										<a class="btn btn-sm btn-outline-secondary" href="{{ path('admin_user_show', { id: user.id, tab: 'expenses', notes_filter: 'week', notes_week: notesWeek + 1, notes_page: notesPage, notes_size: notesSize }) }}">Next</a>
									</div>
								</div>
							{% endif %}
							{% if expenseNotes|length > 0 %}
								<div class="table-responsive">
									<table class="table table-sm table-striped align-middle">
										<thead>
											<tr>
												<th>Date</th>
												<th>Amount TTC</th>
												<th>VAT</th>
												<th>Type</th>
												<th>Invoice</th>
												<th>Valide</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for n in expenseNotes %}
												<tr>
													<td>{{ n.noteDate|date('Y-m-d') }}</td>
													<td>{{ n.amountTtc|number_format(3, '.', ' ') }}</td>
													<td>
														{% if n.vat is not null %}
															{{ n.vat|number_format(3, '.', ' ') }}
														{% else %}
															<span class="text-muted">N/A</span>
														{% endif %}
													</td>
													<td>{{ n.type }}</td>
													<td>
														{% if n.invoice %}
															{% set invUrl = attachmentUrls[n.invoice.id] ?? null %}
															{% if invUrl %}
																<a href="{{ invUrl }}" target="_blank" class="link-primary">Open</a>
															{% else %}
																<span class="text-muted">N/A</span>
															{% endif %}
														{% else %}
															<span class="text-muted">None</span>
														{% endif %}
													</td>
													<td>
														{% if n.valide is same as(true) %}
															<span class="badge bg-success">Valid</span>
														{% elseif n.valide is same as(false) %}
															<span class="badge bg-danger">Invalid</span>
														{% else %}
															<span class="badge bg-secondary">Unset</span>
														{% endif %}
													</td>
													<td>
														<form method="post" action="{{ path('admin_expense_note_valide', { id: n.id }) }}" class="d-inline">
															<input type="hidden" name="_token" value="{{ csrf_token('set_expense_note_valide_' ~ n.id) }}"/>
															<input type="hidden" name="valide" value="1"/>
															<button type="submit" class="btn btn-sm btn-outline-success">Mark Valid</button>
														</form>
														<form method="post" action="{{ path('admin_expense_note_valide', { id: n.id }) }}" class="d-inline ms-1">
															<input type="hidden" name="_token" value="{{ csrf_token('set_expense_note_valide_' ~ n.id) }}"/>
															<input type="hidden" name="valide" value="0"/>
															<button type="submit" class="btn btn-sm btn-outline-danger">Mark Invalid</button>
														</form>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
								{% if notesTotalPages > 1 %}
									<div class="d-flex align-items-center justify-content-between mt-2">
										<div>Page
											{{ notesPage }}
											of
											{{ notesTotalPages }}</div>
										<div class="btn-group">
											<a class="btn btn-outline-secondary btn-sm {% if notesPage <= 1 %}disabled{% endif %}" href="{{ path('admin_user_show', { id: user.id, notes_page: notesPage - 1, notes_size: notesSize, tab: 'expenses', notes_filter: notesFilter, notes_week: notesWeek }) }}">Previous</a>
											<a class="btn btn-outline-secondary btn-sm {% if notesPage >= notesTotalPages %}disabled{% endif %}" href="{{ path('admin_user_show', { id: user.id, notes_page: notesPage + 1, notes_size: notesSize, tab: 'expenses', notes_filter: notesFilter, notes_week: notesWeek }) }}">Next</a>
										</div>
									</div>
								{% endif %}
							{% else %}
								<div class="text-muted">No expense notes</div>
							{% endif %}
						</div>
					</div>

					<div class="tab-pane fade {{ activeTab == 'batches' ? 'show active' : '' }}" id="tab-batches" role="tabpanel">
						{% if batches|length > 0 %}
							<div class="table-responsive">
								<table class="table table-sm table-striped align-middle">
									<thead>
										<tr>
											<th>Integration</th>
											<th>Period</th>
											<th>Total Amount</th>
										</tr>
									</thead>
									<tbody>
										{% for b in batches %}
											<tr>
												<td>{{ b.integration.code }}</td>
												<td>{{ b.periodStart|date('Y-m-d') }}
													→
													{{ b.periodEnd|date('Y-m-d') }}</td>
												<td>{{ b.totalAmount|number_format(3, '.', ' ') }}</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
							{% if batchesTotalPages > 1 %}
								<div class="d-flex align-items-center justify-content-between mt-2">
									<div>Page
										{{ batchesPage }}
										of
										{{ batchesTotalPages }}</div>
									<div class="btn-group">
										<a class="btn btn-outline-secondary btn-sm {% if batchesPage <= 1 %}disabled{% endif %}" href="{{ path('admin_user_show', { id: user.id, ops_page: opsPage, ops_size: opsSize, batches_page: batchesPage - 1, batches_size: batchesSize, tab: 'batches' }) }}">Previous</a>
										<a class="btn btn-outline-secondary btn-sm {% if batchesPage >= batchesTotalPages %}disabled{% endif %}" href="{{ path('admin_user_show', { id: user.id, ops_page: opsPage, ops_size: opsSize, batches_page: batchesPage + 1, batches_size: batchesSize, tab: 'batches' }) }}">Next</a>
									</div>
								</div>
							{% endif %}
						{% else %}
							<div class="text-muted">No payment batches</div>
						{% endif %}
					</div>
				{% else %}
					<div class="tab-pane fade" id="tab-ops" role="tabpanel">
						<div class="text-muted">No driver profile</div>
					</div>
					<div class="tab-pane fade" id="tab-batches" role="tabpanel">
						<div class="text-muted">No driver profile</div>
					</div>
				{% endif %}
				<div class="tab-pane fade {{ activeTab == 'neoo' ? 'show active' : '' }}" id="tab-neoo" role="tabpanel">
					{% if not driver %}
						<div class="text-muted">No driver profile</div>
					{% else %}
						<div class="d-flex align-items-center justify-content-between mb-2">
							<form method="get" action="{{ path('admin_user_show', { id: user.id }) }}" class="d-flex align-items-center gap-2">
								<input type="hidden" name="tab" value="neoo"/>
								<div>
									<label class="form-label mb-0 small">Begin</label>
									<input type="date" name="neoo_start" class="form-control form-control-sm" value="{{ neooStart|date('Y-m-d') }}"/>
								</div>
								<div>
									<label class="form-label mb-0 small">End</label>
									<input type="date" name="neoo_end" class="form-control form-control-sm" value="{{ neooEnd|date('Y-m-d') }}"/>
								</div>
								<div class="align-self-end">
									<button type="submit" class="btn btn-sm btn-primary">Apply</button>
								</div>
							</form>
							<div class="text-muted small">
								{{ neooStart|date('Y-m-d') }}
								→
								{{ neooEnd|date('Y-m-d') }}
							</div>
						</div>
						<div class="table-responsive mb-3">
							<table class="table table-bordered align-middle">
								<caption class="fw-bold">Activité & commission (sans % de commission)</caption>
								<tbody>
									<tr>
										<td>CA HT reversé plateformes</td>
										<td class="text-end">{{ neooTotalIn|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>Fixe NEOO mensuel (selon tranche CA)</td>
										<td class="text-end">{{ neooFixed|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>Taux global charges URSSAF (paramètre)</td>
										<td class="text-end">
											{{ neooUrssaf|number_format(3, '.', ' ') }}
											%
										</td>
									</tr>
									<tr>
										<td>Commission variable (égale aux CHARGES URSSAF)</td>
										<td class="text-end">{{ neooCommissionVariable|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>Total commission NEOO (fixe + variable)</td>
										<td class="text-end">{{ neooTotalCommission|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>Reversement chauffeur BRUT (enveloppe)</td>
										<td class="text-end">{{ neooReversementBrut|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div class="table-responsive mb-3">
							<table class="table table-bordered align-middle">
								<caption class="fw-bold">Frais professionnels TTC (avancés)</caption>
								<thead>
									<tr>
										<th>Type</th>
										<th class="text-end">Total TTC</th>
									</tr>
								</thead>
								<tbody>
									{% set totalExp = 0 %}
									{% for t, v in neooExpenseGroups %}
										<tr>
											<td>{{ t }}</td>
											<td class="text-end">{{ v|number_format(3, '.', ' ') }}
												EUR</td>
										</tr>
										{% set totalExp = totalExp + v %}
									{% endfor %}
									<tr class="fw-bold">
										<td>Total</td>
										<td class="text-end">{{ totalExp|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div class="table-responsive mb-3">
							<table class="table table-bordered align-middle">
								<caption class="fw-bold">TVA (information – sur les frais)</caption>
								<tbody>
									<tr>
										<td>Taux TVA moyen sur total frais pro</td>
										<td class="text-end">20%</td>
									</tr>
									<tr>
										<td>TVA récupérable (part TVA dans TTC)</td>
										<td class="text-end">{{ neooVatRecoverable|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div class="table-responsive mb-3">
							<table class="table table-bordered align-middle">
								<caption class="fw-bold">SALAIRE NET SOCIAL 6) Salaire soumis à cotisations / Net social</caption>
								<tbody>
									<tr>
										<td>Frais professionnels HT (calcul)</td>
										<td class="text-end">
											{{ neooC27|number_format(3, '.', ' ') }}
											EUR
										</td>
									</tr>
									<tr>
										<td>Salaire brut soumis à cotisations</td>
										<td class="text-end">
											{{ neooSalaireBrutCotisations|number_format(3, '.', ' ') }}
											EUR
										</td>
									</tr>
									<tr>
										<td>SALAIRE NET SOCIAL (avant PAS)</td>
										<td class="text-end">{{ neooNetSocial|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>Taux PAS</td>
										<td class="text-end">{{ neooTauxPas|number_format(3, '.', ' ') }}
											%</td>
									</tr>
									<tr>
										<td>Montant PAS</td>
										<td class="text-end">{{ neooMontantPas|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>Acompte sur salaire déjà versé</td>
										<td class="text-end">{{ neooAcompte|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>Net social après PAS et acompte</td>
										<td class="text-end">{{ neooNetSocialAfter|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div class="table-responsive mb-3">
							<table class="table table-bordered align-middle">
								<caption class="fw-bold">Indemnités kilométriques (LÉGALES – au km réel)</caption>
								<tbody>
									<tr>
										<td>Kilomètres professionnels du mois (km)</td>
										<td class="text-end">{{ neooKm|number_format(3, '.', ' ') }}
											km</td>
									</tr>
									<tr>
										<td>Taux IK (€/km) – barème fiscal</td>
										<td class="text-end">{{ neooFraisKm|number_format(3, '.', ' ') }}
											EUR/km</td>
									</tr>
									<tr>
										<td>Indemnité kilométrique (montant)</td>
										<td class="text-end">{{ neooIk|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div class="table-responsive mb-3">
							<table class="table table-bordered align-middle">
								<caption class="fw-bold">Congés payés (option : indemnité non soumise)</caption>
								<tbody>
									<tr>
										<td>Taux congés payés</td>
										<td class="text-end">{{ neooCpTaux|number_format(3, '.', ' ') }}</td>
									</tr>
									<tr>
										<td>Indemnité congés payés (non soumise)</td>
										<td class="text-end">{{ neooCpIndemnite|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
								</tbody>
							</table>
						</div>

						<div class="table-responsive mb-3">
							<table class="table table-bordered align-middle">
								<caption class="fw-bold">Remboursements non imposables & net à payer</caption>
								<tbody>
									<tr>
										<td>Remboursements NON imposables</td>
										<td class="text-end">{{ neooRemboursementsNonImposables|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
									<tr>
										<td>NET FINAL À PAYER</td>
										<td class="text-end">{{ neooNetFinalPayer|number_format(3, '.', ' ') }}
											EUR</td>
									</tr>
								</tbody>
							</table>
						</div>
					{% endif %}
				</div>
			</div>
		{% endif %}
	</div>
{% endblock %}
